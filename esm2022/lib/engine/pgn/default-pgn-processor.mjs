import { King } from '../../models/pieces/king';
import { Pawn } from '../../models/pieces/pawn';
import { MoveUtils } from '../../utils/move-utils';
import { AbstractPgnProcessor } from './abstract-pgn-processor';
export class DefaultPgnProcessor extends AbstractPgnProcessor {
    process(board, sourcePiece, destPoint, destPiece) {
        this.currentIndex += 0.5;
        let currentMove = '';
        if (this.currentIndex % Math.floor(this.currentIndex) === 0) {
            currentMove = this.currentIndex + '. ';
        }
        let possibleCaptures = [];
        let possibleMoves = [];
        if (destPiece) {
            possibleCaptures = MoveUtils.findPieceByPossibleCapturesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        }
        possibleMoves = MoveUtils.findPieceByPossibleMovesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        if (sourcePiece instanceof Pawn && !destPiece && possibleCaptures.length === 0) {
            currentMove += MoveUtils.formatSingle(destPoint, board.reverted);
        }
        else {
            if (sourcePiece instanceof Pawn && destPiece) {
                currentMove += (MoveUtils.formatSingle(sourcePiece.point, board.reverted).substring(0, 1) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted));
            }
            else {
                if (sourcePiece instanceof King && (Math.abs(sourcePiece.point.col - destPoint.col) === 2)) {
                    if (board.reverted) {
                        currentMove += (destPoint.col < 2
                            ? 'O-O'
                            : 'O-O-O');
                    }
                    else {
                        currentMove += destPoint.col < 3
                            ? 'O-O-O'
                            : 'O-O';
                    }
                }
                else {
                    if (!(sourcePiece instanceof Pawn) && possibleCaptures.length === 0 && possibleMoves.length < 2) { // Nf3
                        currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatSingle(destPoint, board.reverted);
                    }
                    else {
                        if (possibleMoves && possibleMoves.length === 2 && possibleCaptures.length === 0) { // Nbd7
                            if (this.isEqualByCol(possibleMoves[0], possibleMoves[1])) {
                                currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                            else {
                                currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                        else {
                            if (possibleCaptures.length > 1) {
                                if ((this.isEqualByCol(possibleCaptures[0], possibleCaptures[1]))) {
                                    currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                                else {
                                    currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                            }
                            else {
                                currentMove += MoveUtils.getFirstLetterPiece(sourcePiece) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                    }
                }
            }
        }
        this.pgn.push(currentMove);
    }
    resolvePieceByFirstChar(move, piece) {
        return MoveUtils.getFirstLetterPiece(piece) === move;
    }
    isEqualByCol(aPiece, bPiece) {
        return aPiece.point.col === bPiece.point.col;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL3Bnbi9kZWZhdWx0LXBnbi1wcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUdoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDbkQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFaEUsTUFBTSxPQUFPLG1CQUFvQixTQUFRLG9CQUFvQjtJQUVsRCxPQUFPLENBQ1YsS0FBWSxFQUNaLFdBQWtCLEVBQ2xCLFNBQWdCLEVBQ2hCLFNBQWlCO1FBRWpCLElBQUksQ0FBQyxZQUFZLElBQUksR0FBRyxDQUFDO1FBQ3pCLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFHLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hELFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztTQUMxQztRQUNELElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUV2QixJQUFJLFNBQVMsRUFBRTtZQUNYLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxxQ0FBcUMsQ0FDOUQsU0FBUyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUNqRCxLQUFLLEVBQ0wsV0FBVyxDQUFDLEtBQUssQ0FDcEIsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FB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LE9BQU8sU0FBUyxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQztJQUN6RCxDQUFDO0lBRU8sWUFBWSxDQUFDLE1BQWEsRUFBRSxNQUFhO1FBQzdDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7SUFDakQsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9hcmQgfSBmcm9tICcuLi8uLi9tb2RlbHMvYm9hcmQnO1xyXG5pbXBvcnQgeyBLaW5nIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3BpZWNlcy9raW5nJztcclxuaW1wb3J0IHsgUGF3biB9IGZyb20gJy4uLy4uL21vZGVscy9waWVjZXMvcGF3bic7XHJcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3BpZWNlcy9waWVjZSc7XHJcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vLi4vbW9kZWxzL3BpZWNlcy9wb2ludCc7XHJcbmltcG9ydCB7IE1vdmVVdGlscyB9IGZyb20gJy4uLy4uL3V0aWxzL21vdmUtdXRpbHMnO1xyXG5pbXBvcnQgeyBBYnN0cmFjdFBnblByb2Nlc3NvciB9IGZyb20gJy4vYWJzdHJhY3QtcGduLXByb2Nlc3Nvcic7XHJcblxyXG5leHBvcnQgY2xhc3MgRGVmYXVsdFBnblByb2Nlc3NvciBleHRlbmRzIEFic3RyYWN0UGduUHJvY2Vzc29yIHtcclxuXHJcbiAgICBwdWJsaWMgcHJvY2VzcyhcclxuICAgICAgICBib2FyZDogQm9hcmQsXHJcbiAgICAgICAgc291cmNlUGllY2U6IFBpZWNlLFxyXG4gICAgICAgIGRlc3RQb2ludDogUG9pbnQsXHJcbiAgICAgICAgZGVzdFBpZWNlPzogUGllY2VcclxuICAgICk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuY3VycmVudEluZGV4ICs9IDAuNTtcclxuICAgICAgICBsZXQgY3VycmVudE1vdmUgPSAnJztcclxuICAgICAgICBpZih0aGlzLmN1cnJlbnRJbmRleCAlIE1hdGguZmxvb3IodGhpcy5jdXJyZW50SW5kZXgpID09PSAwKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRNb3ZlID0gdGhpcy5jdXJyZW50SW5kZXggKyAnLiAnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcG9zc2libGVDYXB0dXJlcyA9IFtdO1xyXG4gICAgICAgIGxldCBwb3NzaWJsZU1vdmVzID0gW107XHJcblxyXG4gICAgICAgIGlmIChkZXN0UGllY2UpIHtcclxuICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxyXG4gICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShkZXN0UG9pbnQsIGJvYXJkLnJldmVydGVkKSxcclxuICAgICAgICAgICAgICAgIGJvYXJkLFxyXG4gICAgICAgICAgICAgICAgc291cmNlUGllY2UuY29sb3JcclxuICAgICAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gcGllY2UuY29uc3RydWN0b3IubmFtZSA9PT0gc291cmNlUGllY2UuY29uc3RydWN0b3IubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBvc3NpYmxlTW92ZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcclxuICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShkZXN0UG9pbnQsIGJvYXJkLnJldmVydGVkKSxcclxuICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgIHNvdXJjZVBpZWNlLmNvbG9yXHJcbiAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gcGllY2UuY29uc3RydWN0b3IubmFtZSA9PT0gc291cmNlUGllY2UuY29uc3RydWN0b3IubmFtZSk7XHJcblxyXG4gICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24gJiYgIWRlc3RQaWVjZSAmJiBwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBjdXJyZW50TW92ZSArPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24gJiYgZGVzdFBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50TW92ZSArPSAoTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZS5wb2ludCxcclxuICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgKS5zdWJzdHJpbmcoMCwgMSkgKyAneCcgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc291cmNlUGllY2UgaW5zdGFuY2VvZiBLaW5nICYmIChNYXRoLmFicyhzb3VyY2VQaWVjZS5wb2ludC5jb2wgLSBkZXN0UG9pbnQuY29sKSA9PT0gMikpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYm9hcmQucmV2ZXJ0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gKGRlc3RQb2ludC5jb2wgPCAyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdPLU8nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdPLU8tTycpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNb3ZlICs9IGRlc3RQb2ludC5jb2wgPCAzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdPLU8tTydcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ08tTyc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIShzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24pICYmIHBvc3NpYmxlQ2FwdHVyZXMubGVuZ3RoID09PSAwICYmIHBvc3NpYmxlTW92ZXMubGVuZ3RoIDwgMikgeyAgICAgLy8gTmYzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNb3ZlICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZU1vdmVzICYmIHBvc3NpYmxlTW92ZXMubGVuZ3RoID09PSAyICYmIHBvc3NpYmxlQ2FwdHVyZXMubGVuZ3RoID09PSAwKSB7ICAgIC8vIE5iZDdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRXF1YWxCeUNvbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZU1vdmVzWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3NpYmxlTW92ZXNbMV1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW92ZSArPSAgTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5yZXZlcnNlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQucm93XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW92ZSArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgTW92ZVV0aWxzLmZvcm1hdENvbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LmNvbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRoaXMuaXNFcXVhbEJ5Q29sKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZUNhcHR1cmVzWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NzaWJsZUNhcHR1cmVzWzFdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vdmUgKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMucmV2ZXJzZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UucG9pbnQucm93XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyAneCcgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW92ZSArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRDb2woXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LmNvbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW92ZSArPSBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LCBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5wZ24ucHVzaChjdXJyZW50TW92ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihtb3ZlOiBzdHJpbmcsIHBpZWNlOiBQaWVjZSkge1xyXG4gICAgICAgIHJldHVybiBNb3ZlVXRpbHMuZ2V0Rmlyc3RMZXR0ZXJQaWVjZShwaWVjZSkgPT09IG1vdmU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc0VxdWFsQnlDb2woYVBpZWNlOiBQaWVjZSwgYlBpZWNlOiBQaWVjZSkge1xyXG4gICAgICAgIHJldHVybiBhUGllY2UucG9pbnQuY29sID09PSBiUGllY2UucG9pbnQuY29sO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=