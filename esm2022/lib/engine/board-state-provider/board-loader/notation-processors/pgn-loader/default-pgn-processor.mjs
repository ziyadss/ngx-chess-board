import { Bishop } from '../../../../../models/pieces/bishop';
import { Color } from '../../../../../models/pieces/color';
import { King } from '../../../../../models/pieces/king';
import { Knight } from '../../../../../models/pieces/knight';
import { Pawn } from '../../../../../models/pieces/pawn';
import { Point } from '../../../../../models/pieces/point';
import { Queen } from '../../../../../models/pieces/queen';
import { Rook } from '../../../../../models/pieces/rook';
import { MoveUtils } from '../../../../../utils/move-utils';
import { DefaultPiecesLoader } from '../../default-pieces-loader';
export class DefaultPgnProcessor {
    process(notation, engineFacade) {
        if (notation) {
            engineFacade.board.reverted = false;
            engineFacade.board.pieces = [];
            engineFacade.reset();
            DefaultPiecesLoader.loadDefaultPieces(engineFacade.board);
            let moves = this.extractMoves(notation);
            let counter = -1;
            for (let move of moves) {
                ++counter;
                move = move.replace(/[+#]/g, '');
                let promotionIndex = '';
                if (move.includes('=')) {
                    promotionIndex = this.resolvePromotion(move.substring(move.length - 1));
                    move = move.substring(0, move.length - 2);
                }
                let color = (counter === 0 || counter % 2 === 0)
                    ? Color.WHITE
                    : Color.BLACK;
                if (/^[a-z]\d$/g.test(move)) { // zwykly ruch na wolne pole e4
                    let piece = MoveUtils.findPieceByPossibleMovesContaining(move, engineFacade.board, color).find(piece => piece instanceof Pawn);
                    // en passant check
                    if (!piece) {
                        piece = MoveUtils.findPieceByPossibleCapturesContaining(move, engineFacade.board, color).find(piece => piece instanceof Pawn);
                    }
                    // if piece is found for sure
                    if (piece) {
                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move + promotionIndex);
                    }
                }
                else {
                    if (/^[A-Z][a-h]\d$/g.test(move)) { // jezeli ma wielka litere, czyli trzeba odszukac ktora figura Nf3
                        let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(1), engineFacade.board, color);
                        let piece = pieces.find(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                        if (piece) {
                            engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(1) + promotionIndex);
                        }
                        else {
                        }
                    }
                    else {
                        if ('O-O' === move) {
                            engineFacade.move(color === Color.WHITE ? 'e1g1' : 'e8g8');
                        }
                        else {
                            if (/^[a-z]x[a-z]\d$/g.test(move)) { //exd5
                                let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => piece instanceof Pawn);
                                let piece;
                                if (pieces.length > 1) {
                                    piece = this.resolveByCol(pieces, move.substring(0, 1));
                                }
                                else {
                                    piece = pieces[0];
                                }
                                if (piece) {
                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                }
                                else {
                                }
                            }
                            else {
                                if (/^[A-Z]x[a-z]\d$/g.test(move)) {
                                    let piece = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).find(piece => this.resolvePieceByFirstChar(move.substring(0, 1), piece));
                                    if (piece) {
                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                    }
                                    else {
                                    }
                                }
                                else {
                                    if (move === 'O-O-O') {
                                        engineFacade.move(color === Color.WHITE ? 'e1c1' : 'e8c8');
                                    }
                                    else {
                                        if (/^[A-Z]\dx[a-z]\d$/g.test(move)) { //Ngxe4 sytuacja 2 skoczkow pion bicie
                                            let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                            let piece = this.resolveByRow(pieces, move.substring(1, 2));
                                            if (piece) {
                                                engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                            }
                                        }
                                        else {
                                            if (/^[A-Z][a-z][a-z]\d$/g.test(move)) { // dwie wieze bez bicia Rac1 pion
                                                let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                if (piece) {
                                                    engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(2, 4) + promotionIndex);
                                                }
                                            }
                                            else {
                                                if (/^[A-Z][a-z]x[a-z]\d$/g.test(move)) {
                                                    let pieces = MoveUtils.findPieceByPossibleCapturesContaining(move.substring(move.indexOf('x') + 1), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
                                                    let piece = this.resolveByCol(pieces, move.substring(1, 2));
                                                    if (piece) {
                                                        engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(move.indexOf('x') + 1) + promotionIndex);
                                                    }
                                                }
                                                else {
                                                    this.processR1f2(move, engineFacade, color, promotionIndex);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    processR1f2(move, engineFacade, color, promotionIndex) {
        if (/^[A-Z]\d[a-z]\d$/g.test(move)) { // R1f2
            let pieces = MoveUtils.findPieceByPossibleMovesContaining(move.substring(2, 4), engineFacade.board, color).filter(piece => this.resolvePieceByFirstChar(move.charAt(0), piece));
            let piece = this.resolveByRow(pieces, move.substring(1, 2));
            if (piece) {
                engineFacade.move(MoveUtils.formatSingle(piece.point, false) + move.substring(2, 4) + promotionIndex);
            }
        }
    }
    extractMoves(notation) {
        return notation.substring(notation.lastIndexOf(']') + 1)
            .replace(/[0-9]+\./g, '')
            .replace(/\s+/g, ' ')
            .replace(/{[^}]*}/g, '')
            .trim()
            .split(' ')
            .filter(s => s);
    }
    movePiece(piece, board, move) {
        let indexes = MoveUtils.translateCoordsToIndex(move, board.reverted);
        piece.point.col = indexes.xAxis;
        piece.point.row = indexes.yAxis;
    }
    hasUpperCase(move) {
        return /[A-Z]/.test(move);
    }
    resolvePieceByFirstChar(move, piece) {
        let piecesFirstChar = '';
        if (piece instanceof King) {
            piecesFirstChar = 'K';
        }
        else {
            if (piece instanceof Queen) {
                piecesFirstChar = 'Q';
            }
            else {
                if (piece instanceof Rook) {
                    piecesFirstChar = 'R';
                }
                else {
                    if (piece instanceof Bishop) {
                        piecesFirstChar = 'B';
                    }
                    else {
                        if (piece instanceof Knight) {
                            piecesFirstChar = 'N';
                        }
                        else {
                            if (piece instanceof Pawn) {
                                piecesFirstChar = 'P';
                            }
                        }
                    }
                }
            }
        }
        return move === piecesFirstChar;
    }
    isShortCastle(move) {
        return move === 'O-O';
    }
    removePiece(coords, board) {
        let indexes = MoveUtils.translateCoordsToIndex(coords, board.reverted);
        board.pieces = board.pieces.filter(e => !e.point.isEqual(new Point(indexes.yAxis, indexes.xAxis)));
    }
    isLongCastle(move) {
        return move === 'O-O-O';
    }
    resolveByCol(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(0, 1) === char
            ? pieces[0]
            : pieces[1];
    }
    resolveByRow(pieces, char) {
        let firstPieceFormat = MoveUtils.formatSingle(pieces[0].point, false);
        let secondPieceFormat = MoveUtils.formatSingle(pieces[1].point, false);
        return firstPieceFormat.substring(1, 2) === char
            ? pieces[0]
            : pieces[1];
    }
    replacePromotion(move) {
        return move
            .replace('=Q', '1')
            .replace('=R', '2')
            .replace('=B', '3')
            .replace('=K', '4');
    }
    resolvePromotion(promotionChar) {
        switch (promotionChar) {
            case 'Q':
                return '1';
            case 'R':
                return '2';
            case 'B':
                return '3';
            case 'N':
                return '4';
        }
        return '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL2JvYXJkLXN0YXRlLXByb3ZpZGVyL2JvYXJkLWxvYWRlci9ub3RhdGlvbi1wcm9jZXNzb3JzL3Bnbi1sb2FkZXIvZGVmYXVsdC1wZ24tcHJvY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0QsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFekQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzNELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMzRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDekQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRTVELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR2xFLE1BQU0sT0FBTyxtQkFBbUI7SUFFckIsT0FBTyxDQUFDLFFBQWdCLEVBQUUsWUFBa0M7UUFDL0QsSUFBSSxRQUFRLEVBQUU7WUFDVixZQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7WUFDcEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQy9CLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNyQixtQkFBbUIs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QUM1QyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLElBQVk7UUFDakMsT0FBTyxJQUFJO2FBQ04sT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7YUFDbEIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7YUFDbEIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7YUFDbEIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsYUFBcUI7UUFDMUMsUUFBUSxhQUFhLEVBQUU7WUFDbkIsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1lBQ2YsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1lBQ2YsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1lBQ2YsS0FBSyxHQUFHO2dCQUNKLE9BQU8sR0FBRyxDQUFDO1NBQ2xCO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb2FyZCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9ib2FyZCc7XHJcbmltcG9ydCB7IEJpc2hvcCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvYmlzaG9wJztcclxuaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL2NvbG9yJztcclxuaW1wb3J0IHsgS2luZyB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMva2luZyc7XHJcbmltcG9ydCB7IEtuaWdodCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMva25pZ2h0JztcclxuaW1wb3J0IHsgUGF3biB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL21vZGVscy9waWVjZXMvcGF3bic7XHJcbmltcG9ydCB7IFBpZWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9waWVjZSc7XHJcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9wb2ludCc7XHJcbmltcG9ydCB7IFF1ZWVuIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vbW9kZWxzL3BpZWNlcy9xdWVlbic7XHJcbmltcG9ydCB7IFJvb2sgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9tb2RlbHMvcGllY2VzL3Jvb2snO1xyXG5pbXBvcnQgeyBNb3ZlVXRpbHMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi91dGlscy9tb3ZlLXV0aWxzJztcclxuaW1wb3J0IHsgQWJzdHJhY3RFbmdpbmVGYWNhZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9hYnN0cmFjdC1lbmdpbmUtZmFjYWRlJztcclxuaW1wb3J0IHsgRGVmYXVsdFBpZWNlc0xvYWRlciB9IGZyb20gJy4uLy4uL2RlZmF1bHQtcGllY2VzLWxvYWRlcic7XHJcbmltcG9ydCB7IE5vdGF0aW9uUHJvY2Vzc29yIH0gZnJvbSAnLi4vbm90YXRpb24tcHJvY2Vzc29yJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEZWZhdWx0UGduUHJvY2Vzc29yIGltcGxlbWVudHMgTm90YXRpb25Qcm9jZXNzb3Ige1xyXG5cclxuICAgIHB1YmxpYyBwcm9jZXNzKG5vdGF0aW9uOiBzdHJpbmcsIGVuZ2luZUZhY2FkZTogQWJzdHJhY3RFbmdpbmVGYWNhZGUpOiB2b2lkIHtcclxuICAgICAgICBpZiAobm90YXRpb24pIHtcclxuICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLnJldmVydGVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZC5waWVjZXMgPSBbXTtcclxuICAgICAgICAgICAgZW5naW5lRmFjYWRlLnJlc2V0KCk7XHJcbiAgICAgICAgICAgIERlZmF1bHRQaWVjZXNMb2FkZXIubG9hZERlZmF1bHRQaWVjZXMoZW5naW5lRmFjYWRlLmJvYXJkKTtcclxuICAgICAgICAgICAgbGV0IG1vdmVzID0gdGhpcy5leHRyYWN0TW92ZXMobm90YXRpb24pO1xyXG4gICAgICAgICAgICBsZXQgY291bnRlciA9IC0xO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBtb3ZlIG9mIG1vdmVzKSB7XHJcbiAgICAgICAgICAgICAgICArK2NvdW50ZXI7XHJcbiAgICAgICAgICAgICAgICBtb3ZlID0gbW92ZS5yZXBsYWNlKC9bKyNdL2csICcnKTtcclxuICAgICAgICAgICAgICAgIGxldCBwcm9tb3Rpb25JbmRleCA9ICcnO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChtb3ZlLmluY2x1ZGVzKCc9JykpIHtcclxuICAgICAgICAgICAgICAgICAgICBwcm9tb3Rpb25JbmRleCA9IHRoaXMucmVzb2x2ZVByb21vdGlvbihtb3ZlLnN1YnN0cmluZyhtb3ZlLmxlbmd0aCAtIDEpKTtcclxuICAgICAgICAgICAgICAgICAgICBtb3ZlID0gbW92ZS5zdWJzdHJpbmcoMCwgbW92ZS5sZW5ndGggLSAyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgY29sb3IgPSAoY291bnRlciA9PT0gMCB8fCBjb3VudGVyICUgMiA9PT0gMClcclxuICAgICAgICAgICAgICAgICAgICA/IENvbG9yLldISVRFXHJcbiAgICAgICAgICAgICAgICAgICAgOiBDb2xvci5CTEFDSztcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoL15bYS16XVxcZCQvZy50ZXN0KG1vdmUpKSB7IC8vIHp3eWtseSBydWNoIG5hIHdvbG5lIHBvbGUgZTRcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2UgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvclxyXG4gICAgICAgICAgICAgICAgICAgICkuZmluZChwaWVjZSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBlbiBwYXNzYW50IGNoZWNrXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwaWVjZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwaWVjZSA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSwgZW5naW5lRmFjYWRlLmJvYXJkLCBjb2xvclxyXG4gICAgICAgICAgICAgICAgICAgICAgICApLmZpbmQocGllY2UgPT4gcGllY2UgaW5zdGFuY2VvZiBQYXduKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIHBpZWNlIGlzIGZvdW5kIGZvciBzdXJlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlICsgcHJvbW90aW9uSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1bYS1oXVxcZCQvZy50ZXN0KG1vdmUpKSB7Ly8gamV6ZWxpIG1hIHdpZWxrYSBsaXRlcmUsIGN6eWxpIHRyemViYSBvZHN6dWthYyBrdG9yYSBmaWd1cmEgTmYzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKDEpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLmJvYXJkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gcGllY2VzLmZpbmQocGllY2UgPT4gdGhpcy5yZXNvbHZlUGllY2VCeUZpcnN0Q2hhcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuY2hhckF0KDApLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIG1vdmUuc3Vic3RyaW5nKDEpICsgcHJvbW90aW9uSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCdPLU8nID09PSBtb3ZlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShjb2xvciA9PT0gQ29sb3IuV0hJVEUgPyAnZTFnMScgOiAnZThnOCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW2Etel14W2Etel1cXGQkL2cudGVzdChtb3ZlKSkgeyAvL2V4ZDVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZigneCcpICsgMSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiBwaWVjZSBpbnN0YW5jZW9mIFBhd24pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gdGhpcy5yZXNvbHZlQnlDb2woXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygwLCAxKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlID0gcGllY2VzWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5tb3ZlKE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZS5wb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBtb3ZlLnN1YnN0cmluZyhtb3ZlLmluZGV4T2YoJ3gnKSArIDEpICsgcHJvbW90aW9uSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoL15bQS1aXXhbYS16XVxcZCQvZy50ZXN0KG1vdmUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmluZChwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMCwgMSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcobW92ZS5pbmRleE9mKCd4JykgKyAxKSArIHByb21vdGlvbkluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3ZlID09PSAnTy1PLU8nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShjb2xvciA9PT0gQ29sb3IuV0hJVEUgPyAnZTFjMScgOiAnZThjOCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1cXGR4W2Etel1cXGQkL2cudGVzdChtb3ZlKSkgeyAgLy9OZ3hlNCBzeXR1YWNqYSAyIHNrb2N6a293IHBpb24gYmljaWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVDYXB0dXJlc0NvbnRhaW5pbmcoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZigneCcpICsgMSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmZpbHRlcihwaWVjZSA9PiB0aGlzLnJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlSb3coXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5zdWJzdHJpbmcoMSwgMilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLm1vdmUoTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIG1vdmUuc3Vic3RyaW5nKG1vdmUuaW5kZXhPZihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd4JykgKyAxKSArIHByb21vdGlvbkluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvXltBLVpdW2Etel1bYS16XVxcZCQvZy50ZXN0KG1vdmUpKSB7IC8vIGR3aWUgd2llemUgYmV6IGJpY2lhIFJhYzEgcGlvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygyLCA0KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlDb2woXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxLCAyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgcHJvbW90aW9uSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eW0EtWl1bYS16XXhbYS16XVxcZCQvZy50ZXN0KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZUNhcHR1cmVzQ29udGFpbmluZyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZyhtb3ZlLmluZGV4T2YoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd4JykgKyAxKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUuYm9hcmQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92ZS5jaGFyQXQoMCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaWVjZSA9IHRoaXMucmVzb2x2ZUJ5Q29sKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxLCAyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArIG1vdmUuc3Vic3RyaW5nKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlLmluZGV4T2YoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAneCcpICsgMSkgKyBwcm9tb3Rpb25JbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NSMWYyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdmUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lRmFjYWRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21vdGlvbkluZGV4XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcHJvY2Vzc1IxZjIobW92ZSwgZW5naW5lRmFjYWRlLCBjb2xvciwgcHJvbW90aW9uSW5kZXgpIHtcclxuICAgICAgICBpZiAoL15bQS1aXVxcZFthLXpdXFxkJC9nLnRlc3QobW92ZSkpIHsgLy8gUjFmMlxyXG4gICAgICAgICAgICBsZXQgcGllY2VzID0gTW92ZVV0aWxzLmZpbmRQaWVjZUJ5UG9zc2libGVNb3Zlc0NvbnRhaW5pbmcoXHJcbiAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygyLCA0KSxcclxuICAgICAgICAgICAgICAgIGVuZ2luZUZhY2FkZS5ib2FyZCxcclxuICAgICAgICAgICAgICAgIGNvbG9yXHJcbiAgICAgICAgICAgICkuZmlsdGVyKHBpZWNlID0+IHRoaXMucmVzb2x2ZVBpZWNlQnlGaXJzdENoYXIoXHJcbiAgICAgICAgICAgICAgICBtb3ZlLmNoYXJBdCgwKSxcclxuICAgICAgICAgICAgICAgIHBpZWNlXHJcbiAgICAgICAgICAgICkpO1xyXG5cclxuICAgICAgICAgICAgbGV0IHBpZWNlID0gdGhpcy5yZXNvbHZlQnlSb3coXHJcbiAgICAgICAgICAgICAgICBwaWVjZXMsXHJcbiAgICAgICAgICAgICAgICBtb3ZlLnN1YnN0cmluZygxLCAyKVxyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgaWYgKHBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICBlbmdpbmVGYWNhZGUubW92ZShNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgIHBpZWNlLnBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGZhbHNlXHJcbiAgICAgICAgICAgICAgICApICsgbW92ZS5zdWJzdHJpbmcoXHJcbiAgICAgICAgICAgICAgICAgICAgMixcclxuICAgICAgICAgICAgICAgICAgICA0XHJcbiAgICAgICAgICAgICAgICApICsgcHJvbW90aW9uSW5kZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBleHRyYWN0TW92ZXMobm90YXRpb246IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBub3RhdGlvbi5zdWJzdHJpbmcobm90YXRpb24ubGFzdEluZGV4T2YoJ10nKSArIDEpXHJcbiAgICAgICAgICAgIC5yZXBsYWNlKC9bMC05XStcXC4vZywgJycpXHJcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICcgJylcclxuICAgICAgICAgICAgLnJlcGxhY2UoL3tbXn1dKn0vZywgJycpXHJcbiAgICAgICAgICAgIC50cmltKClcclxuICAgICAgICAgICAgLnNwbGl0KCcgJylcclxuICAgICAgICAgICAgLmZpbHRlcihzID0+IHMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBtb3ZlUGllY2UocGllY2U6IFBpZWNlLCBib2FyZDogQm9hcmQsIG1vdmU6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBpbmRleGVzID0gTW92ZVV0aWxzLnRyYW5zbGF0ZUNvb3Jkc1RvSW5kZXgobW92ZSwgYm9hcmQucmV2ZXJ0ZWQpO1xyXG4gICAgICAgIHBpZWNlLnBvaW50LmNvbCA9IGluZGV4ZXMueEF4aXM7XHJcbiAgICAgICAgcGllY2UucG9pbnQucm93ID0gaW5kZXhlcy55QXhpcztcclxuICAgIH1cclxuXHJcbiAgICBoYXNVcHBlckNhc2UobW92ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIC9bQS1aXS8udGVzdChtb3ZlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKG1vdmU6IHN0cmluZywgcGllY2U6IFBpZWNlKSB7XHJcbiAgICAgICAgbGV0IHBpZWNlc0ZpcnN0Q2hhciA9ICcnO1xyXG4gICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtpbmcpIHtcclxuICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ0snO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIFF1ZWVuKSB7XHJcbiAgICAgICAgICAgICAgICBwaWVjZXNGaXJzdENoYXIgPSAnUSc7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBSb29rKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ1InO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGllY2UgaW5zdGFuY2VvZiBCaXNob3ApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ0InO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaWVjZSBpbnN0YW5jZW9mIEtuaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzRmlyc3RDaGFyID0gJ04nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpZWNlIGluc3RhbmNlb2YgUGF3bikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlc0ZpcnN0Q2hhciA9ICdQJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbW92ZSA9PT0gcGllY2VzRmlyc3RDaGFyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNTaG9ydENhc3RsZShtb3ZlOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gbW92ZSA9PT0gJ08tTyc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZW1vdmVQaWVjZShjb29yZHM6IHN0cmluZywgYm9hcmQ6IEJvYXJkKSB7XHJcbiAgICAgICAgbGV0IGluZGV4ZXMgPSBNb3ZlVXRpbHMudHJhbnNsYXRlQ29vcmRzVG9JbmRleChjb29yZHMsIGJvYXJkLnJldmVydGVkKTtcclxuXHJcbiAgICAgICAgYm9hcmQucGllY2VzID0gYm9hcmQucGllY2VzLmZpbHRlcihlID0+ICFlLnBvaW50LmlzRXF1YWwobmV3IFBvaW50KFxyXG4gICAgICAgICAgICBpbmRleGVzLnlBeGlzLFxyXG4gICAgICAgICAgICBpbmRleGVzLnhBeGlzXHJcbiAgICAgICAgKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNMb25nQ2FzdGxlKG1vdmU6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBtb3ZlID09PSAnTy1PLU8nO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzb2x2ZUJ5Q29sKHBpZWNlczogUGllY2VbXSwgY2hhcjogc3RyaW5nKTogUGllY2Uge1xyXG4gICAgICAgIGxldCBmaXJzdFBpZWNlRm9ybWF0ID0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZXNbMF0ucG9pbnQsIGZhbHNlKTtcclxuICAgICAgICBsZXQgc2Vjb25kUGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1sxXS5wb2ludCwgZmFsc2UpO1xyXG4gICAgICAgIHJldHVybiBmaXJzdFBpZWNlRm9ybWF0LnN1YnN0cmluZygwLCAxKSA9PT0gY2hhclxyXG4gICAgICAgICAgICA/IHBpZWNlc1swXVxyXG4gICAgICAgICAgICA6IHBpZWNlc1sxXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc29sdmVCeVJvdyhwaWVjZXM6IFBpZWNlW10sIGNoYXI6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBmaXJzdFBpZWNlRm9ybWF0ID0gTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShwaWVjZXNbMF0ucG9pbnQsIGZhbHNlKTtcclxuICAgICAgICBsZXQgc2Vjb25kUGllY2VGb3JtYXQgPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKHBpZWNlc1sxXS5wb2ludCwgZmFsc2UpO1xyXG4gICAgICAgIHJldHVybiBmaXJzdFBpZWNlRm9ybWF0LnN1YnN0cmluZygxLCAyKSA9PT0gY2hhclxyXG4gICAgICAgICAgICA/IHBpZWNlc1swXVxyXG4gICAgICAgICAgICA6IHBpZWNlc1sxXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlcGxhY2VQcm9tb3Rpb24obW92ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIG1vdmVcclxuICAgICAgICAgICAgLnJlcGxhY2UoJz1RJywgJzEnKVxyXG4gICAgICAgICAgICAucmVwbGFjZSgnPVInLCAnMicpXHJcbiAgICAgICAgICAgIC5yZXBsYWNlKCc9QicsICczJylcclxuICAgICAgICAgICAgLnJlcGxhY2UoJz1LJywgJzQnKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc29sdmVQcm9tb3Rpb24ocHJvbW90aW9uQ2hhcjogc3RyaW5nKSB7XHJcbiAgICAgICAgc3dpdGNoIChwcm9tb3Rpb25DaGFyKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ1EnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICcxJztcclxuICAgICAgICAgICAgY2FzZSAnUic6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJzInO1xyXG4gICAgICAgICAgICBjYXNlICdCJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiAnMyc7XHJcbiAgICAgICAgICAgIGNhc2UgJ04nOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICc0JztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==